<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±ÙˆØ´â€ŒÙ‡Ø§ - CRM ÙØ§Ø±Ø³ÛŒ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Persian Fonts -->
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vazirmatn@33.0.3/Vazirmatn-font-face.min.css" rel="stylesheet">
    
    <!-- Animation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    
    <!-- Custom Styles -->
    <style>
        :root {
            --royal-blue: #1e3a8a;
            --royal-gold: #d4af37;
            --dark-bg: #0a0a0a;
            --card-bg: #1f2937;
        }
        
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: var(--dark-bg);
            color: #ffffff;
        }
        
        .card-royal {
            background: var(--card-bg);
            border: 1px solid rgba(212, 175, 55, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .card-royal:hover {
            border-color: var(--royal-gold);
            box-shadow: 0 20px 40px rgba(212, 175, 55, 0.2);
            transform: translateY(-4px);
        }
        
        .btn-royal {
            background: linear-gradient(135deg, var(--royal-blue) 0%, #3b82f6 100%);
            border: 1px solid var(--royal-gold);
            transition: all 0.3s ease;
        }
        
        .btn-royal:hover {
            background: linear-gradient(135deg, #1e40af 0%, var(--royal-blue) 100%);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
            transform: translateY(-2px);
        }
        
        .text-gold {
            color: var(--royal-gold);
        }
        
        .nav-glass {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .sale-card {
            background: var(--card-bg);
            border: 1px solid rgba(212, 175, 55, 0.2);
            transition: all 0.3s ease;
        }
        
        .sale-card:hover {
            border-color: var(--royal-gold);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.2);
        }
        
        .form-input {
            background: var(--card-bg);
            border: 1px solid rgba(212, 175, 55, 0.3);
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            border-color: var(--royal-gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .product-item {
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .total-section {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.2) 0%, rgba(212, 175, 55, 0.2) 100%);
            border: 1px solid rgba(212, 175, 55, 0.3);
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-completed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .status-cancelled {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .chart-container {
            background: rgba(31, 41, 55, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Background Canvas for Particles -->
    <div id="background-canvas"></div>
    
    <!-- Navigation Header -->
    <nav class="nav-glass fixed top-0 left-0 right-0 z-40">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center space-x-4">
                    <div class="text-2xl font-bold text-gold">ğŸ’ CRM ÙØ§Ø±Ø³ÛŒ</div>
                </div>
                
                <!-- Search Bar -->
                <div class="flex-1 max-w-md mx-8">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="sale-search"
                            placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ±ÙˆØ´..."
                            class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 pr-10 text-white placeholder-gray-400 focus:border-yellow-400 focus:outline-none"
                        >
                        <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                
                <!-- Date/Time Display -->
                <div class="flex items-center space-x-6 text-sm">
                    <div class="text-center">
                        <div data-persian-date class="text-gold font-medium"></div>
                        <div data-persian-time class="text-blue-300"></div>
                    </div>
                    
                    <!-- User Avatar -->
                    <div class="flex items-center space-x-2">
                        <img src="resources/user-avatar.jpg" alt="Ú©Ø§Ø±Ø¨Ø±" class="w-8 h-8 rounded-full border-2 border-yellow-400">
                        <span class="hidden md:block">Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…</span>
                    </div>
                    
                    <!-- Menu Toggle -->
                    <button id="menu-toggle" class="p-2 rounded-lg hover:bg-gray-700 transition-colors">
                        <i class="fas fa-bars text-gold"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Side Menu -->
    <div id="side-menu" class="fixed top-0 right-0 h-full w-64 bg-gray-900 transform translate-x-full transition-transform duration-300 z-50">
        <div class="p-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-gold">Ù…Ù†Ùˆ</h3>
                <button id="menu-close" class="p-2 hover:bg-gray-700 rounded-lg">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <nav class="space-y-2">
                <a href="index.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-home"></i>
                    <span>ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</span>
                </a>
                <a href="customers.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-users"></i>
                    <span>Ù…Ø´ØªØ±ÛŒØ§Ù†</span>
                </a>
                <a href="sales.html" class="flex items-center space-x-3 p-3 rounded-lg bg-blue-600 text-white">
                    <i class="fas fa-chart-line"></i>
                    <span>ÙØ±ÙˆØ´â€ŒÙ‡Ø§</span>
                </a>
                <a href="accounts.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-calculator"></i>
                    <span>Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§</span>
                </a>
                <a href="reminders.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-bell"></i>
                    <span>ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§</span>
                </a>
                <a href="dashboard.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-chart-bar"></i>
                    <span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
                </a>
            </nav>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="pt-20">
        <!-- Page Header -->
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div class="mb-4 md:mb-0">
                        <h1 class="text-3xl font-bold text-gold mb-2">
                            <i class="fas fa-chart-line ml-2"></i>
                            Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±ÙˆØ´â€ŒÙ‡Ø§
                        </h1>
                        <p class="text-gray-400">Ø«Ø¨Øª Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ ÙØ±ÙˆØ´â€ŒÙ‡Ø§ Ùˆ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</p>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Add Sale Button -->
                        <button onclick="window.crmApp.showModal('add-sale-modal')" class="btn-royal px-6 py-2 rounded-lg font-medium">
                            <i class="fas fa-plus ml-2"></i>
                            ÙØ±ÙˆØ´ Ø¬Ø¯ÛŒØ¯
                        </button>
                        
                        <!-- Export Button -->
                        <button onclick="exportSales()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-download ml-2"></i>
                            Ø®Ø±ÙˆØ¬ÛŒ
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Sales Summary -->
        <section class="py-4 bg-gray-900">
            <div class="container mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="card-royal p-4 rounded-xl">
                        <div class="flex items-center">
                            <div class="text-3xl text-gold mr-4">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-white" id="total-sales-count">-</div>
                                <div class="text-gray-400 text-sm">Ú©Ù„ ÙØ±ÙˆØ´â€ŒÙ‡Ø§</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-royal p-4 rounded-xl">
                        <div class="flex items-center">
                            <div class="text-3xl text-green-400 mr-4">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-white" id="total-revenue">-</div>
                                <div class="text-gray-400 text-sm">Ú©Ù„ Ø¯Ø±Ø¢Ù…Ø¯</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-royal p-4 rounded-xl">
                        <div class="flex items-center">
                            <div class="text-3xl text-blue-400 mr-4">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-white" id="avg-sale-value">-</div>
                                <div class="text-gray-400 text-sm">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ÙØ±ÙˆØ´</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-royal p-4 rounded-xl">
                        <div class="flex items-center">
                            <div class="text-3xl text-yellow-400 mr-4">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-white" id="today-sales">-</div>
                                <div class="text-gray-400 text-sm">ÙØ±ÙˆØ´ Ø§Ù…Ø±ÙˆØ²</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Filters Section -->
        <section class="py-4">
            <div class="container mx-auto px-4">
                <div class="card-royal p-4 rounded-xl">
                    <div class="flex flex-wrap items-center gap-4">
                        <!-- Filter by Date -->
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-400">ØªØ§Ø±ÛŒØ®:</label>
                            <select id="date-filter" class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-1 text-white text-sm focus:border-yellow-400 focus:outline-none">
                                <option value="">Ù‡Ù…Ù‡ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§</option>
                                <option value="today">Ø§Ù…Ø±ÙˆØ²</option>
                                <option value="week">Ø§ÛŒÙ† Ù‡ÙØªÙ‡</option>
                                <option value="month">Ø§ÛŒÙ† Ù…Ø§Ù‡</option>
                            </select>
                        </div>
                        
                        <!-- Filter by Status -->
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-400">ÙˆØ¶Ø¹ÛŒØª:</label>
                            <select id="status-filter" class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-1 text-white text-sm focus:border-yellow-400 focus:outline-none">
                                <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                                <option value="completed">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
                                <option value="pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
                                <option value="cancelled">Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
                            </select>
                        </div>
                        
                        <!-- Filter by Customer -->
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-400">Ù…Ø´ØªØ±ÛŒ:</label>
                            <select id="customer-filter" class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-1 text-white text-sm focus:border-yellow-400 focus:outline-none">
                                <option value="">Ù‡Ù…Ù‡ Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§</option>
                            </select>
                        </div>
                        
                        <!-- Clear Filters -->
                        <button onclick="clearFilters()" class="text-yellow-400 hover:text-yellow-300 text-sm">
                            <i class="fas fa-times ml-1"></i>
                            Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„ØªØ±Ù‡Ø§
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Sales Chart -->
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="chart-container p-6 mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-gold">
                        <i class="fas fa-chart-area ml-2"></i>
                        Ù†Ù…ÙˆØ¯Ø§Ø± ÙØ±ÙˆØ´
                    </h3>
                    <div id="sales-chart" style="height: 400px;"></div>
                </div>
            </div>
        </section>
        
        <!-- Sales List -->
        <section class="py-8">
            <div class="container mx-auto px-4">
                <div class="card-royal rounded-xl overflow-hidden">
                    <div class="p-6 border-b border-gray-700">
                        <h3 class="text-xl font-semibold text-gold">
                            <i class="fas fa-list ml-2"></i>
                            Ù„ÛŒØ³Øª ÙØ±ÙˆØ´â€ŒÙ‡Ø§
                        </h3>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-800">
                                <tr>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Ú©Ø¯ ÙØ±ÙˆØ´</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Ù…Ø´ØªØ±ÛŒ</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Ù…Ø­ØµÙˆÙ„Ø§Øª</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Ù…Ø¨Ù„Øº Ú©Ù„</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">ØªØ§Ø±ÛŒØ®</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">ÙˆØ¶Ø¹ÛŒØª</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="sales-table-body" class="divide-y divide-gray-700">
                                <!-- Table rows will be dynamically generated -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="empty-state" class="hidden text-center py-12">
                    <div class="text-6xl text-gray-600 mb-4">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-400 mb-2">Ù‡ÛŒÚ† ÙØ±ÙˆØ´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
                    <p class="text-gray-500 mb-6">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ ÙØ±ÙˆØ´ Ø¬Ø¯ÛŒØ¯ÛŒ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯</p>
                    <button onclick="window.crmApp.showModal('add-sale-modal')" class="btn-royal px-6 py-3 rounded-lg font-medium">
                        <i class="fas fa-plus ml-2"></i>
                        Ø«Ø¨Øª Ø§ÙˆÙ„ÛŒÙ† ÙØ±ÙˆØ´
                    </button>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Add Sale Modal -->
    <div id="add-sale-modal" class="modal fixed inset-0 modal-overlay z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content bg-gray-800 rounded-xl p-6 w-full max-w-4xl max-h-screen overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gold">Ø«Ø¨Øª ÙØ±ÙˆØ´ Ø¬Ø¯ÛŒØ¯</h3>
                    <button class="modal-close text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="add-sale-form" class="space-y-6">
                    <!-- Customer Selection -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ</label>
                        <select name="customerId" required class="form-input w-full rounded-lg px-3 py-2 text-white focus:outline-none">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ...</option>
                        </select>
                    </div>
                    
                    <!-- Products Section -->
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <label class="block text-sm font-medium">Ù…Ø­ØµÙˆÙ„Ø§Øª</label>
                            <button type="button" onclick="addProductRow()" class="text-gold hover:text-yellow-300 text-sm">
                                <i class="fas fa-plus ml-1"></i>
                                Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„
                            </button>
                        </div>
                        
                        <div id="products-container">
                            <!-- Product rows will be added here -->
                        </div>
                    </div>
                    
                    <!-- Sale Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">ØªØ®ÙÛŒÙ (%)</label>
                            <input type="number" name="discount" min="0" max="100" value="0" class="form-input w-full rounded-lg px-3 py-2 text-white focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Ù…Ø§Ù„ÛŒØ§Øª (%)</label>
                            <input type="number" name="tax" min="0" max="100" value="9" class="form-input w-full rounded-lg px-3 py-2 text-white focus:outline-none">
                        </div>
                    </div>
                    
                    <!-- Total Section -->
                    <div class="total-section p-4 rounded-lg">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div>
                                <div class="text-sm text-gray-400">Ø¬Ù…Ø¹ Ú©Ù„</div>
                                <div id="subtotal" class="text-xl font-bold text-white">Û° ØªÙˆÙ…Ø§Ù†</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">ØªØ®ÙÛŒÙ</div>
                                <div id="discount-amount" class="text-xl font-bold text-red-400">Û° ØªÙˆÙ…Ø§Ù†</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">Ù…Ø§Ù„ÛŒØ§Øª</div>
                                <div id="tax-amount" class="text-xl font-bold text-blue-400">Û° ØªÙˆÙ…Ø§Ù†</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ</div>
                                <div id="total-amount" class="text-xl font-bold text-gold">Û° ØªÙˆÙ…Ø§Ù†</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div>
                        <label class="block text-sm font-medium mb-2">ÙˆØ¶Ø¹ÛŒØª ÙØ±ÙˆØ´</label>
                        <select name="status" class="form-input w-full rounded-lg px-3 py-2 text-white focus:outline-none">
                            <option value="completed">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
                            <option value="pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
                            <option value="cancelled">Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
                        </select>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="btn-royal flex-1 py-3 rounded-lg font-medium">
                            <i class="fas fa-save ml-2"></i>
                            Ø«Ø¨Øª ÙØ±ÙˆØ´
                        </button>
                        <button type="button" class="modal-close bg-gray-600 flex-1 py-3 rounded-lg font-medium hover:bg-gray-500 transition-colors">
                            Ø§Ù†ØµØ±Ø§Ù
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="bg-gray-900 border-t border-gray-700 py-8">
        <div class="container mx-auto px-4 text-center">
            <div class="text-gold mb-2">ğŸ’ CRM ÙØ§Ø±Ø³ÛŒ - Ù†Ø³Ø®Ù‡ 1.0</div>
            <div class="text-gray-400 text-sm">
                Â© 1403 ØªÙ…Ø§Ù…ÛŒ Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª - Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ Ø¨Ø±Ø§ÛŒ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±Ù‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒâ€ŒØ²Ø¨Ø§Ù†
            </div>
        </div>
    </footer>
    
    <!-- Scripts -->
    <script src="main.js"></script>
    
    <script>
        let sales = [];
        let filteredSales = [];
        let customers = [];
        let productCounter = 0;
        
        // Sample products for demo
        const sampleProducts = [
            { id: 'p1', name: 'Ù„Ù¾â€ŒØªØ§Ù¾ Ø¯Ù„ XPS 13', price: 45000000 },
            { id: 'p2', name: 'Ú¯ÙˆØ´ÛŒ Ø¢ÛŒÙÙˆÙ† 15 Ù¾Ø±Ùˆ', price: 68000000 },
            { id: 'p3', name: 'ØªØ¨Ù„Øª Ø³Ø§Ù…Ø³ÙˆÙ†Ú¯ ØªØ¨ S9', price: 32000000 },
            { id: 'p4', name: 'Ù‡Ø¯ÙÙˆÙ† Ø³ÙˆÙ†ÛŒ WH-1000XM5', price: 8500000 },
            { id: 'p5', name: 'Ø³Ø§Ø¹Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ù¾Ù„ ÙˆØ§Ú† 9', price: 12000000 },
            { id: 'p6', name: 'Ø¯ÙˆØ±Ø¨ÛŒÙ† Ú©Ø§Ù†Ù† EOS R6', price: 95000000 },
            { id: 'p7', name: 'Ù…Ø§Ù†ÛŒØªÙˆØ± Ø§Ù„â€ŒØ¬ÛŒ 27 Ø§ÛŒÙ†Ú†', price: 18000000 },
            { id: 'p8', name: 'Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù…Ú©Ø§Ù†ÛŒÚ©ÛŒ Ø±ÛŒØ²Ø±', price: 6500000 }
        ];
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await loadData();
            initializeEventListeners();
            renderSales();
            updateSalesSummary();
            initializeSalesChart();
        });
        
        // Load data from storage
        async function loadData() {
            try {
                sales = await window.PersianCRM.storage.getSales();
                customers = await window.PersianCRM.storage.getCustomers();
                filteredSales = [...sales];
                
                // Add sample sales if none exist
                if (sales.length === 0) {
                    await addSampleSales();
                    sales = await window.PersianCRM.storage.getSales();
                    filteredSales = [...sales];
                }
                
                // Populate customer filter
                populateCustomerFilter();
            } catch (error) {
                console.error('Error loading data:', error);
                window.PersianCRM.showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'error');
            }
        }
        
        // Add sample sales for demo
        async function addSampleSales() {
            const sampleSales = [
                {
                    customerId: customers[0]?.id || 'c_001',
                    items: [
                        { productId: 'p1', productName: 'Ù„Ù¾â€ŒØªØ§Ù¾ Ø¯Ù„ XPS 13', qty: 1, unitPrice: 45000000 }
                    ],
                    total: 45000000,
                    discount: 0,
                    tax: 9,
                    status: 'completed'
                },
                {
                    customerId: customers[1]?.id || 'c_002',
                    items: [
                        { productId: 'p2', productName: 'Ú¯ÙˆØ´ÛŒ Ø¢ÛŒÙÙˆÙ† 15 Ù¾Ø±Ùˆ', qty: 1, unitPrice: 68000000 },
                        { productId: 'p4', productName: 'Ù‡Ø¯ÙÙˆÙ† Ø³ÙˆÙ†ÛŒ WH-1000XM5', qty: 1, unitPrice: 8500000 }
                    ],
                    total: 76500000,
                    discount: 5,
                    tax: 9,
                    status: 'completed'
                },
                {
                    customerId: customers[2]?.id || 'c_003',
                    items: [
                        { productId: 'p3', productName: 'ØªØ¨Ù„Øª Ø³Ø§Ù…Ø³ÙˆÙ†Ú¯ ØªØ¨ S9', qty: 2, unitPrice: 32000000 }
                    ],
                    total: 64000000,
                    discount: 10,
                    tax: 9,
                    status: 'pending'
                }
            ];
            
            for (const sale of sampleSales) {
                await window.PersianCRM.storage.addSale(sale);
            }
        }
        
        // Populate customer filter
        function populateCustomerFilter() {
            const select = document.getElementById('customer-filter');
            select.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§</option>';
            
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.firstName} ${customer.lastName}`;
                select.appendChild(option);
            });
        }
        
        // Initialize event listeners
        function initializeEventListeners() {
            // Search
            document.getElementById('sale-search').addEventListener('input', handleSearch);
            
            // Filters
            document.getElementById('date-filter').addEventListener('change', applyFilters);
            document.getElementById('status-filter').addEventListener('change', applyFilters);
            document.getElementById('customer-filter').addEventListener('change', applyFilters);
            
            // Add sale form
            document.getElementById('add-sale-form').addEventListener('submit', handleAddSale);
            
            // Menu close
            document.getElementById('menu-close').addEventListener('click', function() {
                document.getElementById('side-menu').classList.add('translate-x-full');
            });
            
            // Add initial product row
            addProductRow();
        }
        
        // Handle search
        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            
            if (query === '') {
                filteredSales = [...sales];
            } else {
                filteredSales = sales.filter(sale => {
                    const customer = customers.find(c => c.id === sale.customerId);
                    const customerName = customer ? `${customer.firstName} ${customer.lastName}` : '';
                    
                    return sale.id.toLowerCase().includes(query) ||
                           customerName.toLowerCase().includes(query) ||
                           sale.items.some(item => item.productName.toLowerCase().includes(query));
                });
            }
            
            applyFilters();
        }
        
        // Apply filters
        function applyFilters() {
            let filtered = [...filteredSales];
            
            // Date filter
            const dateFilter = document.getElementById('date-filter').value;
            if (dateFilter) {
                const now = new Date();
                let startDate;
                
                switch (dateFilter) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'week':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                }
                
                if (startDate) {
                    filtered = filtered.filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate >= startDate;
                    });
                }
            }
            
            // Status filter
            const statusFilter = document.getElementById('status-filter').value;
            if (statusFilter) {
                filtered = filtered.filter(sale => sale.status === statusFilter);
            }
            
            // Customer filter
            const customerFilter = document.getElementById('customer-filter').value;
            if (customerFilter) {
                filtered = filtered.filter(sale => sale.customerId === customerFilter);
            }
            
            filteredSales = filtered;
            renderSales();
            updateSalesSummary();
        }
        
        // Clear filters
        function clearFilters() {
            document.getElementById('sale-search').value = '';
            document.getElementById('date-filter').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('customer-filter').value = '';
            
            filteredSales = [...sales];
            renderSales();
            updateSalesSummary();
        }
        
        // Render sales table
        function renderSales() {
            const tbody = document.getElementById('sales-table-body');
            tbody.innerHTML = '';
            
            if (filteredSales.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            
            document.getElementById('empty-state').classList.add('hidden');
            
            filteredSales.forEach(sale => {
                const customer = customers.find(c => c.id === sale.customerId);
                const customerName = customer ? `${customer.firstName} ${customer.lastName}` : 'Ù†Ø§Ù…Ø´Ø®Øµ';
                
                const productsHtml = sale.items.map(item => 
                    `<div class="text-sm">${item.productName} (${item.qty}x)</div>`
                ).join('');
                
                const statusClass = `status-${sale.status}`;
                const statusText = {
                    'completed': 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡',
                    'pending': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±',
                    'cancelled': 'Ù„ØºÙˆ Ø´Ø¯Ù‡'
                }[sale.status];
                
                const row = document.createElement('tr');
                row.className = 'table-row hover:bg-gray-800 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">
                        #${sale.id}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        ${customerName}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-300">
                        ${productsHtml}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gold">
                        ${window.PersianCRM.formatCurrency(sale.total)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        ${sale.date || 'ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø´Ø®Øµ'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="viewSale('${sale.id}')" class="text-blue-400 hover:text-blue-300">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="printReceipt('${sale.id}')" class="text-green-400 hover:text-green-300">
                                <i class="fas fa-print"></i>
                            </button>
                            <button onclick="editSale('${sale.id}')" class="text-yellow-400 hover:text-yellow-300">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Update sales summary
        function updateSalesSummary() {
            const totalSales = filteredSales.length;
            const totalRevenue = filteredSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const avgSaleValue = totalSales > 0 ? totalRevenue / totalSales : 0;
            
            // Today's sales
            const today = new Date().toDateString();
            const todaySales = filteredSales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate.toDateString() === today;
            }).length;
            
            document.getElementById('total-sales-count').textContent = 
                window.PersianCRM.utils.toPersianNumbers(totalSales.toString());
            document.getElementById('total-revenue').textContent = 
                window.PersianCRM.formatCurrency(totalRevenue);
            document.getElementById('avg-sale-value').textContent = 
                window.PersianCRM.formatCurrency(avgSaleValue);
            document.getElementById('today-sales').textContent = 
                window.PersianCRM.utils.toPersianNumbers(todaySales.toString());
        }
        
        // Initialize sales chart
        function initializeSalesChart() {
            const chartDom = document.getElementById('sales-chart');
            const myChart = echarts.init(chartDom);
            
            // Generate sample data for the last 30 days
            const dates = [];
            const salesData = [];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toLocaleDateString('fa-IR'));
                
                // Generate realistic sales data
                const baseAmount = 50000000;
                const variation = (Math.random() - 0.5) * 40000000;
                salesData.push(Math.max(10000000, baseAmount + variation));
            }
            
            const option = {
                backgroundColor: 'transparent',
                textStyle: {
                    color: '#ffffff'
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: '#1f2937',
                    borderColor: '#d4af37',
                    textStyle: {
                        color: '#ffffff'
                    },
                    formatter: function(params) {
                        return `${params[0].name}<br/>ÙØ±ÙˆØ´: ${window.PersianCRM.formatCurrency(params[0].value)}`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dates,
                    axisLine: {
                        lineStyle: {
                            color: '#6b7280'
                        }
                    },
                    axisLabel: {
                        color: '#9ca3af'
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: {
                        lineStyle: {
                            color: '#6b7280'
                        }
                    },
                    axisLabel: {
                        color: '#9ca3af',
                        formatter: function(value) {
                            return (value / 1000000).toFixed(0) + 'M';
                        }
                    }
                },
                series: [{
                    name: 'ÙØ±ÙˆØ´',
                    type: 'line',
                    data: salesData,
                    smooth: true,
                    lineStyle: {
                        color: '#d4af37',
                        width: 3
                    },
                    itemStyle: {
                        color: '#d4af37'
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [{
                                offset: 0, color: 'rgba(212, 175, 55, 0.3)'
                            }, {
                                offset: 1, color: 'rgba(212, 175, 55, 0.1)'
                            }]
                        }
                    }
                }]
            };
            
            myChart.setOption(option);
            
            // Make chart responsive
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }
        
        // Add product row to form
        function addProductRow() {
            const container = document.getElementById('products-container');
            const productRow = document.createElement('div');
            productRow.className = 'product-item';
            productRow.id = `product-${productCounter}`;
            
            productRow.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-2">Ù…Ø­ØµÙˆÙ„</label>
                        <select name="products[${productCounter}][productId]" required class="form-input w-full rounded-lg px-3 py-2 text-white focus:outline-none" onchange="updateProductPrice(${productCounter})">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­ØµÙˆÙ„...</option>
                            ${sampleProducts.map(p => `<option value="${p.id}" data-price="${p.price}">${p.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">ØªØ¹Ø¯Ø§Ø¯</label>
                        <input type="number" name="products[${productCounter}][qty]" min="1" value="1" required class="form-input w-full rounded-lg px-3 py-2 text-white focus:outline-none" onchange="calculateTotals()">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</label>
                        <input type="number" name="products[${productCounter}][unitPrice]" min="0" required class="form-input w-full rounded-lg px-3 py-2 text-white focus:outline-none" onchange="calculateTotals()">
                    </div>
                </div>
                
                <div class="flex justify-end mt-2">
                    <button type="button" onclick="removeProductRow(${productCounter})" class="text-red-400 hover:text-red-300 text-sm">
                        <i class="fas fa-times ml-1"></i>
                        Ø­Ø°Ù
                    </button>
                </div>
            `;
            
            container.appendChild(productRow);
            productCounter++;
        }
        
        // Remove product row
        function removeProductRow(index) {
            const productRow = document.getElementById(`product-${index}`);
            if (productRow) {
                productRow.remove();
                calculateTotals();
            }
        }
        
        // Update product price when product is selected
        function updateProductPrice(index) {
            const select = document.querySelector(`select[name="products[${index}][productId]"]`);
            const priceInput = document.querySelector(`input[name="products[${index}][unitPrice]"]`);
            
            if (select && priceInput) {
                const selectedOption = select.options[select.selectedIndex];
                const price = selectedOption.getAttribute('data-price');
                if (price) {
                    priceInput.value = price;
                }
                calculateTotals();
            }
        }
        
        // Calculate totals
        function calculateTotals() {
            let subtotal = 0;
            
            // Calculate subtotal from all products
            for (let i = 0; i < productCounter; i++) {
                const qtyInput = document.querySelector(`input[name="products[${i}][qty]"]`);
                const priceInput = document.querySelector(`input[name="products[${i}][unitPrice]"]`);
                
                if (qtyInput && priceInput) {
                    const qty = parseInt(qtyInput.value) || 0;
                    const price = parseInt(priceInput.value) || 0;
                    subtotal += qty * price;
                }
            }
            
            // Get discount and tax
            const discountPercent = parseFloat(document.querySelector('input[name="discount"]').value) || 0;
            const taxPercent = parseFloat(document.querySelector('input[name="tax"]').value) || 0;
            
            // Calculate amounts
            const discountAmount = subtotal * (discountPercent / 100);
            const taxableAmount = subtotal - discountAmount;
            const taxAmount = taxableAmount * (taxPercent / 100);
            const total = taxableAmount + taxAmount;
            
            // Update display
            document.getElementById('subtotal').textContent = window.PersianCRM.formatCurrency(subtotal);
            document.getElementById('discount-amount').textContent = window.PersianCRM.formatCurrency(discountAmount);
            document.getElementById('tax-amount').textContent = window.PersianCRM.formatCurrency(taxAmount);
            document.getElementById('total-amount').textContent = window.PersianCRM.formatCurrency(total);
        }
        
        // Handle add sale form
        async function handleAddSale(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const customerId = formData.get('customerId');
            const discount = parseFloat(formData.get('discount')) || 0;
            const tax = parseFloat(formData.get('tax')) || 0;
            const status = formData.get('status');
            
            // Collect products
            const items = [];
            for (let i = 0; i < productCounter; i++) {
                const productId = formData.get(`products[${i}][productId]`);
                const qty = parseInt(formData.get(`products[${i}][qty]`)) || 0;
                const unitPrice = parseInt(formData.get(`products[${i}][unitPrice]`)) || 0;
                
                if (productId && qty > 0 && unitPrice > 0) {
                    const product = sampleProducts.find(p => p.id === productId);
                    items.push({
                        productId,
                        productName: product ? product.name : productId,
                        qty,
                        unitPrice
                    });
                }
            }
            
            if (items.length === 0) {
                window.PersianCRM.showToast('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù…Ø­ØµÙˆÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            // Calculate total
            const subtotal = items.reduce((sum, item) => sum + (item.qty * item.unitPrice), 0);
            const discountAmount = subtotal * (discount / 100);
            const taxableAmount = subtotal - discountAmount;
            const taxAmount = taxableAmount * (tax / 100);
            const total = taxableAmount + taxAmount;
            
            const sale = {
                customerId,
                items,
                total,
                discount,
                tax,
                status
            };
            
            try {
                await window.PersianCRM.storage.addSale(sale);
                window.PersianCRM.showToast('ÙØ±ÙˆØ´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯', 'success');
                window.crmApp.hideModal('add-sale-modal');
                e.target.reset();
                
                // Reset products container
                document.getElementById('products-container').innerHTML = '';
                productCounter = 0;
                addProductRow();
                
                // Reload data
                await loadData();
                renderSales();
                updateSalesSummary();
            } catch (error) {
                window.PersianCRM.showToast('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ÙØ±ÙˆØ´', 'error');
            }
        }
        
        // View sale details
        function viewSale(saleId) {
            window.PersianCRM.showToast('Ù‚Ø§Ø¨Ù„ÛŒØª Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§ÙØ²ÙˆØ¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯', 'info');
        }
        
        // Print receipt
        function printReceipt(saleId) {
            window.PersianCRM.showToast('Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø±Ø³ÛŒØ¯...', 'info');
        }
        
        // Edit sale
        function editSale(saleId) {
            window.PersianCRM.showToast('Ù‚Ø§Ø¨Ù„ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§ÙØ²ÙˆØ¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯', 'info');
        }
        
        // Export sales
        function exportSales() {
            const data = JSON.stringify(filteredSales, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sales-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            window.PersianCRM.showToast('Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'success');
        }
        
        // Add event listeners for real-time calculation
        document.addEventListener('change', function(e) {
            if (e.target.name && (e.target.name.includes('qty') || e.target.name.includes('unitPrice') || e.target.name === 'discount' || e.target.name === 'tax')) {
                calculateTotals();
            }
        });
        
        document.addEventListener('input', function(e) {
            if (e.target.name && (e.target.name.includes('qty') || e.target.name.includes('unitPrice') || e.target.name === 'discount' || e.target.name === 'tax')) {
                calculateTotals();
            }
        });
    </script>
</body>
</html>